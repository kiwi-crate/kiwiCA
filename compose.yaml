name: ca-crate

services:
  ca-crate:
    container_name: ${COMPOSE_PROJECT_NAME}
    entrypoint:
      - /bin/sh
      - /root/init.sh
      - "/run/secrets/privkey_password"
      - "/run/secrets/pem_subj"
    env_file: .env.${STAGE}
    hostname: ${COMPOSE_PROJECT_NAME}${FQDN}
    image: ${COMPOSE_PROJECT_NAME}:${STAGE}
    restart: ${CONTAINER_RESTART_POLICY:-unless-stopped}
    secrets:
      - privkey_password
      - pem_subj
    volumes:
      - type: volume
        source: data
        target: /opt/ca-crate
      - type: bind
        source: ${ROOTCA_BIND_LOCATION:-./dummy}
        target: /opt/ca-crate/rootCA

volumes:
  data:
    name: ${COMPOSE_PROJECT_NAME}_data

secrets:
  privkey_password:
    file: ./secrets/.privkey_password_${STAGE}
  pem_subj:
    file: ./secrets/.pem_subj_${STAGE}
